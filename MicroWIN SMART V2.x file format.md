# microwin smart 2.8.2

## smart project file format

- saving multiple times don't change the bytes
- small changes in-app leads to almost whole file changes
  - deletion of an empty network sometimes leads to file size increasing
  - seems like some kind of compression, and/or encryption
  - removing a network and then adding it back results in different file data
- seems to be in little-endian
  - all 2-byte sequences are in little endian byte order
- doesn't seem to contain any timestamp
  - previous versions have a problem with project timestamp, investigate this
- project password protection is based on password authentication
  - zlib stream is unchanged
  - password is salted then hashed
  - salt is stored in the file
  - when file is opened, the program asks for password
  - if password is correct, the file is loaded, otherwise a new empty project is opened instead

## project file structure

- 4 bytes header
  - `SH3\0` -> R02.04.00.00
  - `DEM\0` -> R01.00.00.00
- 12 bytes version
  - R02.04.00.00 -> saved by MicroWin SMART v2.8
  - R01.00.00.00 -> original template file
- 26 null bytes
- 2 bytes salt
  - if salt is 00 00, and password hash is all null, file is not password-protected
  - salt is appended to password, i.e. sha512("password"+"salt")
- 64 or 20 bytes password hash
  - 64 bytes if R02.04.00.00 (SHA512)
  - 20 bytes if R01.00.00.00 (SHA1)
- 4 bytes, little endian number of bytes of uncompressed stream
- zlib compressed stream
  - in case of R03.00.00.00, this is not a simple zlib compressed stream

### zlib stream

- seems to be a single stream inside the .smart project file
- can be decompressed by zlib-flate (give \-uncompress flag)
- can be recompressed by zlib-flate \-compress=6
  - 6 is the default compression ratio, which gives us the 789c header
  - stream can be recompressed with a higher or lower compression ratio, and it seems to be decoded just fine
- contains file name. if file is renamed, the name is stored inside this stream
- doesn't seem to contain any checksum on the data as a whole
  - only some parity info
  - and surely some timestamp info
- if a symbol table is added then deleted, a counter is incremented
- strings are encoded with a length first, then number of bytes following
  - 1 byte length + up to 255 bytes
  - 2 byte length + up to 65535 bytes
  - the terminating null byte is not counted and not stored
  - the string encoding follows the current windows codepage
- project tree open status is not saved
- subroutine editor open status is saved
  - subroutine editor mode (LAD, FBD, STL) is saved
- data is read in like a stream
  - marker / type identifier
  - we need to know how to read each type, they are different

## uncompressed stream

- header
  - 1 byte editor version: 1c
    - 1c = 28 = Micro/WIN SMART v2.8
    - 1b = 27 = Micro/WIN SMART v2.7
    - 1a = 26 = Micro/WIN SMART v2.4
    - 18 = 24 = Micro/WIN SMART v2.4 & v2.5
      - sometimes it doesn't match the version string
    - 12 = original template project file
      - comes with R01.00.00.00 version in the compressed file
  - encoded version
    - 8 bytes: R02.04.00.00
      - 2 bytes: d0 00
        - d0 00 = 0208 = V02.08
        - cf 00 = 0207 = V02.07
        - ce 00 = 0206 = V02.06
        - cd 00 = 0205 = V02.05
      - 2 bytes: c9 00
        - c9 00 = 0201 = 02.01
        - 00 00 = 0000 = 00.00
      - 2 bytes: 03 00
        - 03 00 = 0003 = 00.03
        - 02 00 = 0002 = 00.02
        - 0b 00 = 0011 = ??
          - sometimes it doesn't match the version string
      - 2 bytes: 01 00
        - 01 00 = 0001 = 00.01
    - 4 bytes: R01.00.00
      - 00 01 00 20: corresponding to 4.0.0.46 software version string
        - 20 hex = 32 dec
        - 46 oct = 38 dec
        - 40 oct = 32 dec
        - 46 dec = 56 oct = 2E hex = 00101110 bin
        - not sure how this version is encoded
- 1 byte: 03
- 8 bytes connection info
  - 1 byte: Modbus slave number for Port0
  - 3 bytes null
  - 4 bytes IP address
    - 4 IPv4 octets in normal order
    - not 32-bit encoded IP address
    - this is the last connected PLC IP address
    - if system block is opened and closed, this is cleared
- 1 byte null
- Micro/WIN SMART software version (used to save this file)
  - 2 bytes: 18 00 (string length) -> 0x0018 = 24
  - string: V02.08.02.01_00.03.00.01
  - sometimes this is an unknown version string
  - template file version string: 4.0.0.46
    - this looks like MicroWin v4.0 SPxxx
    - makes sense since S7-200 SMART is derived from S7-200
- 1 byte null
- project file name without .smart extension
  - this changes if the project name changes
  - 2 bytes: 0b 00 (string length) -> 0x000b = 11
  - string: Project1xyz
- 1 byte null
- 1 byte: view mode
  - 00: LAD
  - 01: STL
  - 02: FBD
- 3 bytes null
- [printer information](Printer%20Information.md)
- timestamps
  - 16 bytes timestamp (creation time?)
  - 16 bytes timestamp (last modified?) -> this is updated whenever a symbol table is updated
  - 1 byte: 01
  - 16 bytes timestamp -> this is also updated whenever a symbol table is updated
  - 16 bytes timestamp -> this is updated whenever a data page is updated or created
- [system block](System%20Block.md)
- timestamps
  - 1 byte version
    - 01: R02.04.00.00
    - 00: R01.00.00.00
  - timestamp 1
  - timestamp 2 -> this is updated whenever a symbol table or program block is updated
  - timestamp 3
  - timestamp 4 -> this is updated whenever a data page is updated or created (or symbol table is updated/added/removed)
- program blocks
  - 1 byte identifier: 02
  - 2 bytes number of entries: 04 00
  - order of items
    - main program block (OB1)
    - subroutines (SBRx)
    - interrupt routines (INTx)
  - [program block](Program%20Block.md)
- symbol tables
  - 1 byte version
    - 06: R02.04.00.00
    - 05: R01.00.00.00
  - 2 bytes number of entries: 04 00
  - n [symbol tables](Symbol%20Table.md#symbol%20table)
- [status charts](Status%20Chart.md)
- data pages
  - described in [Data Block](Data%20Block.md)
- 1 byte null
- CPU configuration
  - CPU type string
    - 2 bytes length: 08 00
    - n bytes string contents "CPU SR20" or some other string
  - 1 byte null
  - CPU version string
    - 2 bytes length: 15 00
    - n bytes string contents
  - 2 bytes length of CPU info block: D4 00
  - CPU information block
    - described in [CPU information](CPU%20Information.md)
- 2 bytes null
- project name string
  - 2 bytes length (sometimes 00 00, then no name encoded)
  - n bytes string
- 2 bytes null
- 1 byte: 01
- 4 bytes null
- 16 bytes hash
  - looks like MD5
  - not sure what to hash
- 1 byte: 01
- 4 bytes null
- variable block of data
  - 9 bytes: v2.x
    - 1 byte: 03
    - 8 bytes: 10 00 00 00 00 00 00 00
  - 1 byte: v1.x template
    - 1 byte: 01
- some memory block
  - 4 bytes: number of records
    - 04 00 00 00: v2.x
      - 715 bytes
    - 03 00 00 00: v1.x template
      - 562 bytes
  - each record:
    - 2 bytes:
      - 04 01: v2.x
      - 01 01: v1.x template
    - 8 bytes null
    - 1 byte:
      - 02 for v2.x
      - 01 for v1.x template
    - 4 bytes null
    - 2 bytes: 02 00
    - 4 bytes: 63 6d 88 13
    - null bytes
      - 8 bytes null for v2.x
      - 4 bytes null for v1.x
    - 2 bytes
      - f0 3f for v2.x
      - 80 3f for v1.x
    - variable records
      - 6x 25 repeated bytes: v2.x
        - 1 byte: 02
        - 4 bytes null
        - 4 bytes: 01 00 00 00
        - 16 bytes null
      - 5x 21 repeated bytes: v1.x
        - 1 byte: 01
        - 4 bytes null
        - 4 bytes: 01 00 00 00
        - 12 bytes null
    - variable record
      - 25 bytes: v2.x
        - 1 byte: 01
        - 4 bytes null
        - 4 bytes 04 00 00 00
        - 16 bytes
          - 2 bytes: 01 00
          - 6 bytes null
          - 2 bytes: 00 02
          - 6 bytes null
      - 21 bytes: v1.x
        - 1 byte: 01
        - 4 bytes null
        - 4 bytes 04 00 00 00
        - 12 bytes
          - 1 byte: 01
          - 4 bytes null
          - 4 bytes: 06 00 00 00
          - 1 byte: 01
          - 2 bytes null
    - variable block
      - 10 bytes: v2.x
        - 34 40 00 00
        - 00 e0
        - 4d 62 70 3f
      - 6 bytes: v1.x template
        - a0 41
        - 6f 12 83 3b
    - variable block
      - 21 bytes: v2.x
        - 8 bytes: 00 00 00 a0 99 99 c9 3f
        - 1 byte: 02
        - 8 bytes: 00 00 00 a0 99 99 c9 3f
        - 4 bytes null
      - 9 bytes: v1.x template
        - 4 bytes: cd cc 4c 3e
        - 1 byte: 01
        - 4 bytes: cd cc 4c 3e
    - 2 bytes null
    - 3 bytes:
      - f0 3f 01: v2.x
      - 80 3f 01: v1.x
    - 2x 4 bytes: e8 03 00 00
    - variable block
      - v2.x 28 bytes unknown, a bit repetitive, might be flags
        - 1 byte: 01
        - 4 bytes null
        - 1 byte: 02
        - 8 bytes null
        - 1 byte: 01
        - 4 bytes null
        - 1 byte: 02
        - 7 bytes null
        - 1 byte: 40
      - v1.x template
        - 1 byte: 01
        - 4 bytes null
        - 1 byte: 01
        - 4 bytes null
        - 1 byte: 01
        - 4 byte null
        - 1 byte: 01
        - 3 bytes null
        - 1 byte: 40
    - variable block
      - v2.x
        - 3 bytes null
        - 4 bytes: a0 99 99 c9
        - 2 bytes: 3f 01
        - 34 bytes unknown data
          - sparse
          - looks like flags
        - 14x 4 bytes: 01 00 00 00 -> flag?
        - 4 bytes null
        - 4 bytes: 01 00 00 00
        - 4 bytes null
        - 2 bytes: 02 00
      - v1.x template
        - 4 bytes: cd cc 4c 3e
        - 33 bytes unknown data
          - sparse
          - looks like flags
    - 16 bytes null
    - 28x 11 bytes
      - 3 bytes: 02 03 40
      - 7 bytes null
- pid parameter block
  - 1 byte: 01
  - 4 bytes number of PID:
    - v2.x 10 00 00 00 = 16
    - v1.x 08 00 00 00 = 8
  - 16x 274 bytes PID block
    - 1 byte 03
    - 14x 11 bytes
      - 3 bytes: 02 03 40
      - 8 bytes null
    - 1 byte: 01
    - 2 bytes null
    - 2x 4 bytes: 80 3f 00 00
    - 2 bytes: 20 41
    - 4 bytes null
    - 2 bytes: 01 00
    - 4 bytes null
    - 1 byte: 6c
    - 8 bytes null
    - 2 bytes: c8 42
    - 8 bytes null
    - 2 bytes: 01 00
    - 8 bytes null
    - 1 byte: 6c
    - 6 bytes null
    - 4 bytes: cd cc cc 3d
    - 1 byte: 01
    - 12 bytes null
    - 4 bytes: cd cc cc 3d
    - 4 bytes: 66 66 66 3f
    - 1 byte: 02
    - PID name string
      - 2 bytes length: 09 00
      - string: PID0_CTRL, PID1_CTRL, ...
    - 4 bytes null
    - 1 byte 01
    - PID index
      - 2x 8 bytes
        - 1 byte index: 00, 01, 02 ...
        - 7 bytes null
    - 2 bytes null
  - string:
    - 2 bytes length: 07 00
    - string: PID_EXE
  - 42 bytes unknown
    - 3x 2 bytes: 02 00
    - 1 byte null
    - 4 bytes: 22 00 00 00
    - 1 byte: 08
    - 6 bytes null
    - 2 bytes: 01 00
    - 22 bytes null
- HSC wizard block
  - 2 bytes marker: 04 04
  - 3 bytes null
  - 4 bytes number of HSC: 06 00 00 00
  - 6x 120+ bytes HSC data
    - 2 bytes: 04 01
    - 4 bytes null
    - 1 byte: 01
    - string: name of HSC0 init subroutine
      - 2 bytes length, is 0 if wizard not configured
      - string: PG1_INIT for example
    - 2 bytes null
    - 4 bytes: 01 02 08 01
    - nulls
      - 1 byte length: 0a = 10
      - 10 bytes null
    - 4 bytes: 01 02 08 01
    - 24 bytes null
    - 2 bytes: 00 01
    - 4 bytes null
    - string
      - 2 bytes length: 0d 00 = 13
      - 13 bytes: EXTERN_RESET0, EXTERN_RESET1, ...
      - sometimes 12 bytes with no number suffix
    - 4 bytes null
    - string
      - 2 bytes length: 0b 00 = 11
      - 11 bytes: DIR_CHANGE0, DIR_CHANGE1, ...
    - 4 bytes null
    - string
      - 2 bytes length: 09 00 = 9
      - 9 bytes: COUNT_EQ0, COUNT_EQ1, ...
      - sometimes 8 bytes with no number suffix
    - 4 bytes null
    - 4 bytes flag: 01 00 00 00 if HSC configured or renamed?
    - 4 bytes HSC index: 00 00 00 00, 01 00 00 00, ...
    - string: HSC renamed
      - 1 byte length: 03 for example, can be 00 which means HSC is not renamed
      - string: PG1 for example
- unknown block
  - 1 byte: 01
  - 4 bytes number of records: 04 00 00 00
  - 4x 59 byte records
    - 1 byte: 01
    - 4 bytes null
    - 2 bytes index: 00 00, 01 00, ...
    - 4 bytes null
    - 4 bytes: 01 00 00 00
    - 4x 11 bytes
      - 3 bytes: 02 03 40
      - 8 bytes null
- unknown block
  - 1 byte: 02
  - 4 bytes number of records: 05 00 00 00
  - 5x 106 byte records
    - 2 bytes: 03 01
    - 32 bytes: 8 uint32 flags? only 0 and 1 here, but stored as 32 bits
      - 4 bytes: 01 00 00 00
      - 4 bytes null
      - 4x 4 bytes: 01 00 00 00
      - 4 bytes null
      - 4 bytes: 01 00 00 00
    - 1 byte: 01
    - string
      - 2 bytes length: 07 00
      - string: Chinese
    - 1 byte: 06
    - 4 bytes null
    - 1 byte: 01
    - 18 bytes null
    - 2 bytes index: 00 00, 01 00, 02 00, ...
    - 2 bytes null
    - 2 bytes: 05 00
    - 20 bytes null
    - 2 bytes: 02 00
    - 6 bytes null
    - 4 bytes: 01 00 00 00
- 4 bytes null

- unknown block

  - 2 bytes: 04 04
  - ...

- unknown block

  - 2 bytes: 04 02
  - ...

- possibly another PID block
  - 4 bytes number of PID: 10 00 00 00 = 16
  - 1 byte: 04
  - 1 byte: 02
  - 10 bytes null
  - 16x 347 bytes PID info
    - 2 bytes: 80 bf
    - 6 bytes null
    - 2 bytes: 20 41
    - 10 bytes null
    - 2x 4 bytes: c8 42 00 00
    - 82 bytes null
    - 2x 8 bytes
      - 7 bytes null
      - 1 byte 40
    - 2 bytes: 01 00
    - 8 bytes null
    - 1 byte: 6c
    - 6 bytes null
    - 4 bytes: cd cc cc 3d
    - 8x 11 bytes
      - 3 bytes: 02 03 40
      - bytes null
    - 100 bytes null
- 88 bytes null
- another HSC block at the very end
  - 2 bytes: 04 04
  - 3 bytes null
  - 4 bytes number of HSC: 06 00 00 00
  - 6x 128+ bytes HSC block
    - first 120+ bytes same as the first block
    - 4 bytes flag: 01 00 00 00 if HSC configured or renamed?
    - 4 bytes:
      - null if HSC configured
      - ff ff ff ff if not configured
- 16 bytes null

- note: these look like library subroutines, or built-in tables, or maybe wizard data (???)
  - PID 0...15 are mentioned
  - PG 1..3 INIT are mentioned (specific to winder project)
  - EXTERN_RESET
  - DIR_CHANGE
  - COUNT_EQ
  - are mentioned, seems related to HSC

## misc info & notes

### general notes

- usually, strings have 2 byte lengths (without trailing null)
- likewise, records usually have 2 byte lengths
- integers, offsets, values are usually stored as a 32-bit number
- blocks usually have an ending null byte
- index of positive and negative transitions are not stored inside the project file (they are stored in the CPU)
- Symbol Tables have a minimum number of 1
  - POU Symbols can't be edited nor deleted
- Status Charts have a minimum number of 1
- Data Pages have a minimum number of 1

### CPU versions

- ST and SR series are the standard CPU models
  - 20 30 40 60
  - v1.x to v2.x
- CR series are the lite models
  - CR60: v2.0 v2.1 v2.2
  - CR40: v1.x to v2.0 v2.1 v2.2
  - v2.2 has multiple sub-versions: v2.2.0 v2.2.1 v2.2.2 v2.2.3 v2.2.4
    - no discernible differences exist though
- CR..s series are newer lite models
  - 20 30 40 60
  - v2.3 only

### numeric values

- broadly divided into whole numbers and decimal numbers
- almost always stored as 4 bytes
- whole numbers are further divided into
  - bit: this is 0 or 1
  - byte
  - word / unsigned int
  - int
  - dword / unsigned dint
  - dint
- decimal numbers are stored as a single-precision float value

#### integer constants

- x \< -32768 is negative DINT
- -32768 \<= x \< -128 is negative INT
- -128 \<= x \< 0 is negative BYTE
- 0 \<= x \< 2 is BIT
- 2\<= x \< 128 is positive small BYTE
- 128 \<= x \< 256 is positive BYTE
- 256 \<= x \< 32768 is positive small INT
- 32768 \<= x \< 65536 is positive INT
- 65536 \<= x \< 2147483648 is positive small DINT
- 2147483648 \<= x \< 4294967295 is positive DINT

### timestamp is always 16 bytes

- 2 bytes year
- 2 bytes month
- 2 bytes -- unknown
- 2 bytes day of month
- 2 bytes hour
- 2 bytes minutes
- 2 bytes second
- 2 bytes milliseconds
