# STEP7-200 Micro/WIN SMART V3 File Format

## Project File Structure

- 256 bytes file header
  - 4 bytes null
  - 12 bytes version string:
    - R03.00.00.00
    - R03.01.00.00
  - 104 bytes null
  - 2 bytes protection flags
    - 00 02: project is not password protected
    - 00 01: project is password protected
  - 134 bytes null
- encrypted project data
  - project data is a zip file that is then encrypted
  - encrypted using AES-256-GCM
  - encryption key
    - if project is password protected, password is hashed using SHA-256 to generate key
    - if project is not password-protected, a default password "SMART200_V3_PRJ_KEY" is hashed
  - IV and AAD are predefined constants
    - IV: `95 A6 34 68 4A 46 A9 70 EE 90 76 49`
    - AAD: `4A 14 B3 A5 7B C9 F4 92 EB 46 87 94 62 EF B9 C6`
- 16 bytes GCM authentication tag

## Project Data

Project data is a zip archive. For example, the default template project `template.smartv3` contains files in this order:

## Binary files

- `template\m_mNGMotionCamCfgMap.xml`
- `template\m_mNGMotionAxisCfgMap.xml`
  - motion-control related
- `template\Data Block\USER1.dbbin`
  - data block
  - header: `08 88 13 00`
- [`template\m_cSystemBlockData.bin`](System%20Block)
  - system block data
  - header: `13 06 00 00`
- `template\m_mGlbVarTables.xml`
  - describes global symbol tables (global variable tables)
- `template\m_aUdtTable.xml`
  - stores UDT tables
- [`template\Program Block\MAIN.poubin`](Program%20Block#program-organizational-unit-pou)
- [`template\Program Block\SBR_0.poubin`](Program%20Block#program-organizational-unit-pou)
- [`template\Program Block\INT_0.poubin`](Program%20Block#program-organizational-unit-pou)
- [`template\Program Block\FB_0.poubin`](Program%20Block#program-organizational-unit-pou)
  - these are binary files with XML embedded
    - in v3.0, the XML is at the end
    - in v3.1, there is additional binary data after the XML
- `template\m_mStatusCharts.xml`
  - describes status charts
- `template\m_memAllocator.xml`
  - not sure what this would/should contain
- [`template\m_cUserData.bin`](User%20List)
  - PLC user data, by default it contains only Admin
- `template\template.devproj`
  - main project file
  - contains program version that created the file -- maybe we can use this to determine the file header when writing
  - `AllFeatureList` contains a CPU configuration block in Base64
  - DevMode contains all nulls
  - `%[PROJECT]  /  %[OBJECT]` is print header, `%[PAGE]` is print footer
  - each `file` element has a `hashvalue` attribute, and it is the SHA512 checksum of the file, in Base64
- `template.smartprojs`
  - top-level project XML file

File types:

- `*.xml`, `*.devproj`, and `*.smartprojs` files are XML files.
- `*.dbbin` and `*.bin` files are pure binary files.
- `*.poubin` files are binary files with extra XML data at the end.

### devproj

- xml declaration
- device
  - attributes
    - version: 31 = 3.1
    - name: Project4 -> project name
    - MajorVersion: 301 -> 3.01 firmware version? or MWSmartV3.exe version? this is 301.0.0.3
    - MinorVersion: 0 -> 0.0 ? or MWSmartV3.exe minor version 301.0.0.3
    - BuildNumber: 0 ? maybe MWSmartV3.exe build version 301.0.0.3
    - InstallNumber: 3 ? maybe last digit in MWSmartV3.exe version 301.0.0.3
    - BaudRate: 1 -> 9600 ?
    - DeviceType: CPU ST32
  - children
    - guid: {00000000-0000-0000-0000-000000000000}
    - editor: 0
    - creation: V03.01.00.00_00.00.00.03 -> software version ?
    - DefaultName: 0
    - AddressMode: 0
    - StatMode: 0
    - ProjectType: 0
    - AllUnknownParms: (empty)
    - TimeCreatedCompared: 2026-01-06 08:49:57.085 -> timestamp of creation time
    - TimeLastModifiedCompared: -> looks like modified time or file save time
    - ComparedWith22X: 1
    - TimeOBCompiled: -> 1-2 seconds earlier than TimeLastModifiedCompared
    - TimeDBCompiled: -> time of DB compilation and unbound variable assignment ? same as TimeCreatedCompared
    - TimeCreated: -> same as TimeCreatedCompared
    - TimeModify: -> same as TimeLastModifiedCompared
    - DbTimeCreate: same as TimeCreatedCompared
    - DbTimeModify: same as TimeCreatedCompared
    - DeviceVer: V03.01.00_00.00.00.00 -> firmware version ?
    - AllFeatureList: base64 string of [CPU information](CPU%20Information.md) block (724 bytes of binary data)
    - PropertyGroup
      - children:
        - CompilerProperties
          - attributes:
            - CompilerSwitch: 0
            - LibVisibleName: ""
            - VersionTag: 1.0
            - Protected: 0
            - Password: ""
            - IsDefaultName: 1
          - children:
            - LibPersistentPath
            - guid: {4C6B43B4-1732-48FB-9DCF-583232A62B69}
            - EXLibPOU_elements
        - PRJNetInfo
          - attributes:
            - profibus: 2
            - ip: ""
        - PrintProperties
          - attributes:
            - MarginLeft: 1134
            - MarginTop: 1134
            - MarginRight: 1134
            - MarginBottom: 1134
            - UseAnnotation: 0
            - HeaderJustify: 2
            - FooterJustify: 2
          - children:
            - DevMode: base64 string of null block (156 bytes)
            - header: "%[PROJECT] / %[OBJECT]"
            - footer: "%[PAGE]"
            - field11
            - field12
            - field13
            - field14
            - field2
            - field3
            - field41
            - field42
            - field43
        - LADPrintOptions
          - attributes:
            - col: 8
            - props: 1
            - vars: 1
            - comments: 1
            - syms: 1
            - lines: 0
        - FBDPrintOptions
          - attributes:
            - col: 8
            - props: 1
            - vars: 1
            - comments: 1
            - syms: 1
            - lines: 0
        - STLPrintOptions
          - attributes:
            - col: 0
            - props: 1
            - vars: 1
            - comments: 0
            - syms: 0
            - lines: 1
        - SYMPrintOptions
          - attributes:
            - col: 0
            - props: 1
            - vars: 0
            - comments: 0
            - syms: 0
            - lines: 0
        - CHTPrintOptions
          - attributes:
            - col: 0
            - props: 1
            - vars: 0
            - comments: 0
            - syms: 0
            - lines: 0
        - DBPrintOptions
          - attributes:
            - col: 0
            - props: 1
            - vars: 0
            - comments: 0
            - syms: 0
            - lines: 0
        - RetainFlag: 0
    - UIGroup
      - children:
        - OpenedUdts -> list of UDTs currently viewed?
    - files
      - children:
        - file:
          - attributes:
            - name: Page_1
            - filename: Data Block\Page_1.dbbin
            - mw_id: 5000-0-1-0-00000000-0000-0000-0000-000000000000 -> note 5000d = 0x1388 = 88 13
            - hashvalue: SHA-512 hash of file
        - file:
          - attributes:
            - name: UdtTables
            - filename: m_aUdtTable.xml
            - mw_id: 0-0-1-0-00000000-0000-0000-0000-000000000000
            - hashvalue: SHA-512 hash of file
        - file:
          - attributes:
            - name: MAIN
            - filename: Program Block\MAIN.poubin
            - mw_id: 1000-0-1-0-00000000-0000-0000-0000-000000000000 -> note 1000d = 0x03e8 = e8 03
            - hashvalue: SHA-512 hash of file
        - file:
          - attributes:
            - name: SBR_0
            - filename: Program Block\SBR_0.poubin
            - mw_id: 1001-0-1-0-00000000-0000-0000-0000-000000000000 -> note 1001d = 0x03e9 = e9 03
            - hashvalue: SHA-512 hash of file
        - file:
          - attributes:
            - name: INT_0
            - filename: Program Block\INT_0.poubin
            - mw_id: 1002-0-1-0-00000000-0000-0000-0000-000000000000 -> note 1002d = 0x03ea = ea 03
            - hashvalue: SHA-512 hash of file
        - file:
          - attributes:
            - name: FB_0
            - filename: Program Block\FB_0.poubin
            - mw_id: 1003-0-1-0-00000000-0000-0000-0000-000000000000 -> note 1003d = 0x03eb = eb 03
            - hashvalue: SHA-512 hash of file
        - file:
          - attributes:
            - name: VarTables
            - filename: m_mGlbVarTables.xml
            - mw_id: 0-0-1-0-00000000-0000-0000-0000-000000000000
            - hashvalue: SHA-512 hash of file
        - file:
          - attributes:
            - name: snapshot
            - filename: m_memAllocator.xml
            - mw_id: 0-0-1-0-00000000-0000-0000-0000-000000000000
            - hashvalue: SHA-512 hash of file

### m_mGlbVarTables.xml

- xml declaration
- tables
  - children
    - VarTable
      - attributes:
        - TableType: VT
        - TableName: Variable Table 1
        - Version: 1.0
        - LibOffset: -1
        - mw_id: 3500-0-1-0-00000000-0000-0000-0000-000000000000 -> 3500d = 0x0dac = ac 0d
      - children:
        - Member
    - VarTable
      - attributes:
        - TableType: CONSTVT
        - TableName: Constant Table 1
        - Version: 0.0
        - LibOffset: -1
        - mw_id: 3501-0-1-0-00000000-0000-0000-0000-000000000000 -> 3501d = 0x0dad = ad 0d
    - VarTable
      - attributes:
        - TableType: IOS
        - TableName: I/O Variable
        - Version: 0.0
        - LibOffset: -1
        - mw_id: 3502-0-128-0-00000000-0000-0000-0000-000000000000 -> 3502d = 0x0dae = ae 0d, 128d = 0x80 = 80
    - VarTable
      - attributes:
        - TableType: POUVT
        - TableName: POU Variables
        - Version: 0.0
        - LibOffset: -1
        - mw_id: 3503-0-128-0-00000000-0000-0000-0000-000000000000 -> 3503d = 0x0daf = af 0d, 128d = 0x80 = 80
    - VarTable
      - attributes:
        - TableType: SDVT
        - TableName: System Variable Table
        - Version: 0.0
        - LibOffset: -1
        - mw_id: 3503-1-128-0-00000000-0000-0000-0000-000000000000 -> 3503d = 0x0daf = af 0d, 128d = 0x80 = 80
    - VarTable
      - attributes:
        - TableType: FB
        - TableName: FB Instance Table
        - Version: 0.0
        - LibOffset: -1
        - mw_id: 3505-0-1-0-00000000-0000-0000-0000-000000000000 -> 3505d = 0x0db1 = b1 0d

Member

- attributes:
  - Name -> variable name
  - AccessName -> name used to access variable
    - this is different from Name, in case of UDT member variable
    - for example, Name: Vel, AccessName: udt3.Vel
  - DataType:
    - BOOL, BYTE, WORD, INT, DWORD, DINT, REAL, TIMER, COUNTER
    - STRING<n> for n-byte string, for example: STRING<10>
  - ExtendedDataType -> 32 bits, looks like bit field
    - BOOL ..... : 1610612738d = 0x60000002 = 01100000 00000000 00000000 00000010b
      - SMx.x is the same
      - Ix.x ... : 3758096386d = 0xE0000002 = 11100000 00000000 00000000 00000010b
        - Ix.x is BOOL but has different ExtendedDataType
      - Qx.x ... : 3758096386d = 0xE0000002 = 11100000 00000000 00000000 00000010b
        - Qx.x is BOOL but has different ExtendedDataType
    - BYTE ......... : 262148d = 0x00040004 = 00000000 00000100 00000000 00000100b
      - SMBx is the same
    - WORD ............. : 72d = 0x00000048 = 00000000 00000000 00000000 01001000b
      - SMWx is the same
    - INT .............. : 72d = 0x00000048 = 00000000 00000000 00000000 01001000b
    - DWORD ........... : 144d = 0x00000090 = 00000000 00000000 00000000 10010000b
      - SMDx is the same
    - DINT ............ : 144d = 0x00000090 = 00000000 00000000 00000000 10010000b
    - REAL ........... : 4096d = 0x00001000 = 00000000 00000000 00010000 00000000b
    - STRING ...... : 1048576d = 0x00100000 = 00000000 00010000 00000000 00000000b
    - ARRAY ....... : 4194304d = 0x00400000 = 00000000 01000000 00000000 00000000b
    - TIMER .... : 1610612810d = 0x6000004A = 01100000 00000000 00000000 01001010b
    - COUNTER .. : 1610612810d = 0x6000004A = 01100000 00000000 00000000 01001010b
    - UDT ......... : 2097152d = 0x00200000 = 00000000 00100000 00000000 00000000b
    - SBR ........... : 32768d = 0x00008000 = 00000000 00000000 10000000 00000000b
    - INT ........... : 65536d = 0x00010000 = 00000000 00000001 00000000 00000000b
    - OB ........... : 131072d = 0x00020000 = 00000000 00000010 00000000 00000000b
    - FB ........... : 524288d = 0x00080000 = 00000000 00001000 00000000 00000000b
    - FB instance . : 2097152d = 0x00200000 = 00000000 00100000 00000000 00000000b
  - IniVal -> initial value, defaults shown below
    - BOOL: OFF
    - BYTE, WORD, INT, DWORD, INT: 0
    - REAL: 0.0
    - STRING: empty string value with quotes
    - not present for TIMER, COUNTER
  - Retain -> 1 bit, flag to show if variable is saved by memory retention
  - Bind -> 1 bit, flag to show if variable is manually bound to memory address
  - Commt -> comment
  - sFlags -> 16 bits
    - 16896 = 4200 = 01000010 00000000
      - BOOL, not manually bound, invalid initial value (string without quote, instead of ON/OFF)
    - 16640 = 4100 = 01000001 00000000
      - BOOL, manually bound, invalid initial value (integer instead of ON/OFF)
      - INT, not manually bound, not retained, invalid initial value (string "error"), has comment
    - 16464 = 4050 = 01000000 01010000
      - UDT, manually bound, empty address, was sFlags=16432
    - 16448 = 4040 = 01000000 01000000
      - UDT, manually bound, invalid address (DB2.DBB4 manually typed into address)
      - badValue contains DB2.DB10, this is weird
    - 16440 = 4038 = 01000000 00111000
      - TIMER, manually bound, empty name, empty address, has comment
    - 16432 = 4030 = 01000000 00110000
      - BOOL, TIMER, COUNTER, UDT, manually bound, empty address
    - 16392 = 4008 = 01000000 00001000
      - seen in a CONSTVT line with only comment and nothing else
    - 16384 = 4000 = 01000000 00000000
      - BOOL, not manually bound, assigned DB2 by compile
      - BYTE, manually bound or assigned DB2
      - UDT, not manually bound, not assigned
    - .2048 = 0800 = 00001000 00000000
      - UDT member with overlapping memory
      - DWORD with overlapping memory
    - ..512 = 0200 = 00000010 00000000
      - STRING, invalid initial value (string lorem without quotes)
    - ..256 = 0100 = 00000001 00000000
      - INT, invalid initial value (string "error"), not manually bound
      - STRING, length 5 but given string "something" which is too long
    - ...64 = 0040 = 00000000 01000000
      - UDT member variable, was sFlags=48
    - ...48 = 0030 = 00000000 00110000
      - UDT member variable, manually bound, empty address
      - DINT, manually bound, string with quotes typed into address
    - ...12 = 000c = 00000000 00001100
      - this value has been seen on a blank line
      - FB instance entry with no name
      - invalid variable name with no data type
      - invalid variable name with data type
    - ....8 = 0008 = 00000000 00001000
      - this value usually seen on blank lines
      - also on CONSTVT with no variable name but filled in type and no comment
    - ....0 = 0000 = 00000000 00000000
      - BOOL, not manually bound, not assigned DB2
      - WORD, same
      - INT, same ...
      - DWORD ...
      - DINT
      - REAL
      - STRING
      - TIMER
      - COUNTER
      - UDT
      - I/O Variables manually bound to Ix.x and Qx.x
      - POU Variables manually bound to their respective POUs
      - System Variables manually bound to SMx
      - FB instance
    - overlapping addresses don't seem to be checked or flagged
  - Addr
  - badInit -> only present if initial value is invalid, on BOOL type
    - contains the invalid initialization value
  - badValue -> only present if address is invalid
    - contains the invalid address

sFlags

```
00000000 00000000
^      ^ ^      ^
b15   b8 b7     b0
```

- b14: comment modified
  - either a user-defined variable with a comment
  - or, a system-defined variable and the user has modified (or deleted) the original comment
- b11: overlapping memory
  - value cannot be initialized in symbol table
  - overlapping can be with another variable, can be with an assignment in a data page
  - strings are not considered at all when overlapping in a symbol table
  - however, if a string assignment is made in a data page, it is considered overlapping
  - the data page overrides the symbol table
- b9: malformed input specified as initial value
  - for example, a string without quotes
- b8: recognized data type specified as invalid initial value
  - for example, an integer specified for a BOOL value, or a string specified for an INT value
  - can also be a string of length 10 specified for a STRING<5>, for example
- b6: malformed address
- b5: invalid value specified as address
- b4: Bind=1 but address is empty
- b3: variable name is empty
- b2: variable name is invalid

Special features for UDT:

- UDT can be nested, and they are also nested in the XML
  ```
  <Member ...>
    <Member ...>
      <Member ...>
      ...
  ```
- the UDT Member has Member elements as children, for each member variable
- nesting depth is technically limited to 4 levels, but not enforced until compilation
- UDT member variables are not listed, unless
  - only UDT is retained
  - member variable has a comment
- UDT members inherit Retain and Bind flags from the top level

Blank/empty line has these attributes only:

- ExtendedDataType: 0
- Retain: 0
- Bind: 0
- sFlags: 8 = 0008 = 00000000 00000010
- missing:
  - Name
  - AccessName
  - DataType
  - IniVal
  - Addr
- this seems to line up with the UI -- blank/empty lines don't have Variable Name, Data Type, Initial Value, Address
- ExtendedDataType, sFlags are not on the UI
- Retain, Bind checkboxes are there even if the line is blank/empty

## Notes

- Protection flags `00 03`, `00 04`, ... don't produce any error when the file is opened, but will revert to `00 02` when the file is saved.
  - protection flags `00 00` is invalid
- Project protection password only externally encrypts the zip archive, and does not affect the zipped data in any way.
- https://wiki.openssl.org/index.php/EVP_Authenticated_Encryption_and_Decryption
- `7z` unzips the files just fine, although it complains about header errors.
- When using `zipdetails` to analyze the archive, note that:
  - Warnings of unexpected padding is misplaced, the supposed padding is the actual compressed data.
- It seems that the directory entries are Windows paths, thus they have backslashes in them.
- When the zip archive contents are extracted, then re-archived and re-integrated into a new project file, it seems to work just fine regardless of:
  - order of files
  - compression level
- Only Store and Deflate compression methods are supported.
- The absolute minimum files that need to be present inside the zip archive are:
  - `template.smartprojs`
  - `template\template.devproj`
- The zip archive was created in a non-compliant way, in which backslashes `\` are used instead of forward slashes `/` as directory separators.
  However, reorganizing the files on Linux using directories and then re-archiving the files works just fine.
- STEP 7-Micro/WIN SMART V3 recognizes the project name from the project file name. Internally stored names are overwritten on save.
  This means that renaming a project file will change its internal name the next time it is saved.
- Within the zip archive, there is a file `<project_name>.smartprojs`. This XML file references a file `<project_name>\<project_name>.devproj`.
  Note the use of backslash as directory separator. This directory separator must always be a backslash -- changing it into a forward slash leads to an error when the file is opened.
- However, the file paths inside `<project_name>\<project_name>.devproj` can be converted into forward slashes and it will not raise an error.
- Each program version (so far) only writes a single file version. For example:
  - V3.0 writes R03.00.00.00
  - V3.1 writes R03.01.00.00
  - V2.7 and V2.8 writes R02.04.00.00
- XML
  - XML files all strictly follow XML quotes
  - all attributes are in quotes
  - all attribute values are escaped: &lt; &gt; &quot;
  - seems to be some kind of dump of project variables from memory
    - some parts are still binary, might be rectified in later versions
